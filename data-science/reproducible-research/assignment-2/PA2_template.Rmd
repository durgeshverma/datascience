---
title: "United States Storm and Severe Weather Historic Event Analysis"
output: html_document
author: Durgesh Verma
date: Feb 21, 2015
---

## Synopsis
This report analyze the storm and severe weather events happened in past (between Year 1950 and 2011) in United States. The data is sourced from U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. Report helps to answer two major questions
* One is to analyze the most catastrophic events caused most fatalities and injuries to human population, 
* Another is to analyze the economic damage (property and corps) done by these events. 
The outcome of the analysis shows only top harmful events instead of showing all the events.

## Initial Setup
### Set current working directory

```{r}
cur_dir <- "./"
setwd(cur_dir)
```

* Download data file if not exists in local drive

```{r}
filename <- 'StormData.csv.bz2'
if (!file.exists(filename)) {
    message("downloading file...")
    download.file('https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2', filename, method='curl')
}
```

### Load required libraries

```{r}
library(ggplot2)
library(dplyr)
```

### Preparing data for analysis

* Loading storm data

```{r, cache=TRUE}
rawdata = read.table(bzfile(filename), sep=",", na.strings=c("NA","?"), header=TRUE)
head(rawdata, 3)
```

## Part 1 - Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

### Processing storm data to identify most harmful events

```{r}
q1 = aggregate(cbind(FATALITIES, INJURIES) ~ EVTYPE, data = rawdata, sum)
q1_f = subset(q1, select=c("EVTYPE", "FATALITIES"))
colnames(q1_f) = c("EVTYPE", "COUNT")
q1_f$type <- rep(c("FATALITIES"), nrow(q1_f))

q1_i = subset(q1, select=c("EVTYPE", "INJURIES"))
colnames(q1_i) = c("EVTYPE", "COUNT")
q1_i$type <- rep(c("INJURIES"), nrow(q1_i))

q1 = rbind(q1_f, q1_i)
rm(q1_f, q1_i)

q1_top50 = head(q1[order(q1$COUNT,q1$EVTYPE, na.last=TRUE, decreasing=TRUE),], 50)

```

### Plotting charts to show most harmful events

```{r}
p = qplot(EVTYPE, COUNT, data=q1_top50, facets=type~.) + geom_line(aes(group=type)) + labs(title="Top Harmful Storm Events for Population Health", x="Storm Event", y="Number of persons effected") + theme(axis.text.x=element_text(angle=90, hjust=0, vjust=0))
print(p)

p = qplot(EVTYPE, COUNT, data=q1_top50, color=type) + geom_line(aes(group=type)) + labs(title="Top Harmful Storm Events for Population Health", x="Storm Event", y="Number of persons effected") + theme(axis.text.x=element_text(angle=90, hjust=0, vjust=0))
print(p)
```

### `Results`
TBD

Clean up data
```{r}
rm(q1, q1_top50, p)
```

## Part 2 - Across the United States, which types of events have the greatest economic consequences?

### Processing storm data to identify events caused greatest economic consequences

```{r}
q2 = subset(rawdata, select=c("EVTYPE","PROPDMG","PROPDMGEXP","CROPDMG","CROPDMGEXP"))
q3 <- mutate(q2, prop_damage_amount = ifelse( (PROPDMGEXP=="k" | PROPDMGEXP=="K"), PROPDMG*1000, ifelse( (PROPDMGEXP=="m" | PROPDMGEXP=="M"), PROPDMG*1000000, ifelse( (PROPDMGEXP=="b" | PROPDMGEXP=="B"), PROPDMG*1000000000, PROPDMG) ) ) )
rm(q2)
q3 <- mutate(q3, crop_damage_amount = ifelse( (CROPDMGEXP=="k" | CROPDMGEXP=="K"), CROPDMG*1000, ifelse( (CROPDMGEXP=="m" | CROPDMGEXP=="M"), CROPDMG*1000000, ifelse( (CROPDMGEXP=="b" | CROPDMGEXP=="B"), CROPDMG*1000000000, CROPDMG) ) ) )
q3 <- mutate(q3, total_damage_amount = prop_damage_amount + crop_damage_amount )

q4 = aggregate(cbind(total_damage_amount, prop_damage_amount, crop_damage_amount) ~ EVTYPE, data = q3, sum)
rm(q3)
q4 = subset(q4, total_damage_amount>0)
q4 = q4[order(q4$total_damage_amount, q4$EVTYPE, na.last=TRUE, decreasing=TRUE),]

q5 = head(q4,25)
q51 = subset(q5, select=c("EVTYPE", "prop_damage_amount"))
colnames(q51) = c("EVTYPE", "DAMAGE_AMOUNT")
q51$type <- rep(c("Property"), nrow(q51))

q52 = subset(q5, select=c("EVTYPE", "crop_damage_amount"))
colnames(q52) = c("EVTYPE", "DAMAGE_AMOUNT")
q52$type <- rep(c("Crop"), nrow(q52))

q5 = rbind(q51, q52)
rm(q51, q52)
```

### Plotting charts to show events caused greatest economic consequences

```{r}
p=qplot(EVTYPE, total_damage_amount/1000000, data=head(q4,50))+geom_bar(stat="identity")+labs(title="Top Storm Events caused greatest economic consequences", x="Storm Event", y="Damage Amount (in MM USD)")+theme(axis.text.x=element_text(angle=90, hjust=0, vjust=0))
print(p)

p=qplot(EVTYPE, DAMAGE_AMOUNT/1000000, data=q5, facets=type~.)+geom_line(aes(group=type))+labs(title="Top Storm Events caused greatest economic consequences", x="Storm Event", y="Damage Amount (in MM USD)")+theme(axis.text.x=element_text(angle=90, hjust=0, vjust=0))
print(p)

p=qplot(EVTYPE, DAMAGE_AMOUNT/1000000, data=q5, color=type)+geom_line(aes(group=type))+labs(title="Top Storm Events caused greatest economic consequences", x="Storm Event", y="Damage Amount (in MM USD)")+theme(axis.text.x=element_text(angle=90, hjust=0, vjust=0))
print(p)

rm(q4, q5, p)
```

### `Results`
TBD
